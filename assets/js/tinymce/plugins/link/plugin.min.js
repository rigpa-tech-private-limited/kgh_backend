tinymce.PluginManager.add("link",function(a){function b(b){return function(){var c=a.settings.link_list;"string"==typeof c?tinymce.util.XHR.send({url:c,success:function(a){b(tinymce.util.JSON.parse(a))}}):"function"==typeof c?c(b):b(c)}}function c(a,b,c){function d(a,c){return c=c||[],tinymce.each(a,function(a){var e={text:a.text||a.title};a.menu?e.menu=d(a.menu):(e.value=a.value,b&&b(e)),c.push(e)}),c}return d(a,c||[])}function d(b){function s(a){var b=j.find("#text");(!b.value()||a.lastControl&&b.value()==a.lastControl.text())&&b.value(a.control.text()),j.find("#href").value(a.control.value())}function t(b){var c=[];if(tinymce.each(a.dom.select("a:not([href])"),function(a){var d=a.name||a.id;d&&c.push({text:d,value:"#"+d,selected:b.indexOf("#"+d)!=-1})}),c.length)return c.unshift({text:"None",value:""}),{name:"anchor",type:"listbox",label:"Anchors",values:c,onselect:s}}function u(){!i&&0===d.text.length&&k&&this.parent().parent().find("#text")[0].value(this.value())}function v(b){var c=b.meta||{};m&&m.value(a.convertURL(this.value(),"href")),tinymce.each(b.meta,function(a,b){j.find("#"+b).value(a)}),c.text||u.call(this)}function w(a){var b=e.getContent();if(/</.test(b)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(b)||b.indexOf("href=")==-1))return!1;if(a){var d,c=a.childNodes;if(0===c.length)return!1;for(d=c.length-1;d>=0;d--)if(3!=c[d].nodeType)return!1}return!0}var g,h,i,j,k,l,m,n,o,p,q,r,d={},e=a.selection,f=a.dom;g=e.getNode(),h=f.getParent(g,"a[href]"),k=w(),d.text=i=h?h.innerText||h.textContent:e.getContent({format:"text"}),h?d.target=f.getAttrib(h,"target"):a.settings.default_link_target&&(d.target=a.settings.default_link_target),(r=f.getAttrib(h,"rel"))&&(d.rel=r),(r=f.getAttrib(h,"class"))&&(d.class=r),(r=f.getAttrib(h,"title"))&&(d.title=r),d.href=h?f.getAttrib(h,"href"):"",k&&(l={name:"text",type:"textbox",size:40,label:"Text to display",onchange:function(){d.text=this.value()}}),b&&(m={type:"listbox",label:"Link list",values:c(b,function(b){b.value=a.convertURL(b.value||b.url,"href")},[{text:"None",value:""}]),onselect:s,value:a.convertURL(d.href,"href"),onPostRender:function(){m=this}}),a.settings.target_list!==!1&&(a.settings.target_list||(a.settings.target_list=[{text:"None",value:""},{text:"New window",value:"_blank"}]),o={name:"target",type:"listbox",label:"Target",values:c(a.settings.target_list)}),a.settings.rel_list&&(n={name:"rel",type:"listbox",label:"Rel",values:c(a.settings.rel_list)}),a.settings.link_class_list&&(p={name:"class",type:"listbox",label:"Class",values:c(a.settings.link_class_list,function(b){b.value&&(b.textStyle=function(){return a.formatter.getCssText({inline:"a",classes:[b.value]})})})}),a.settings.link_title!==!1&&(q={name:"title",type:"textbox",label:"Title",value:d.title}),j=a.windowManager.open({title:"Insert link",data:d,body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:!0,label:"Url",onchange:v,onkeyup:u},l,q,t(d.href),m,n,o,p],onSubmit:function(b){function g(b,c){var d=a.selection.getRng();tinymce.util.Delay.setEditorTimeout(a,function(){a.windowManager.confirm(b,function(b){a.selection.setRng(d),c(b)})})}function j(){var b={target:d.target?d.target:null,rel:d.rel?d.rel:null,class:d.class?d.class:null,title:d.title?d.title:null,href:c};h?(a.focus(),k&&d.text!=i&&("innerText"in h?h.innerText=d.text:h.textContent=d.text),f.setAttribs(h,b),e.select(h),a.undoManager.add()):k?a.insertContent(f.createHTML("a",b,f.encode(d.text))):a.execCommand("mceInsertLink",!1,b)}var c;return d=tinymce.extend(d,b.data),(c=d.href)?c.indexOf("@")>0&&c.indexOf("//")==-1&&c.indexOf("mailto:")==-1?void g("The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?",function(a){a&&(c="mailto:"+c),j()}):a.settings.link_assume_external_targets&&!/^\w+:/i.test(c)||!a.settings.link_assume_external_targets&&/^\s*www[\.|\d\.]/i.test(c)?void g("The URL you entered seems to be an external link. Do you want to add the required http:// prefix?",function(a){a&&(c="http://"+c),j()}):void j():void a.execCommand("unlink")}})}a.addButton("link",{icon:"link",tooltip:"Insert/edit link",shortcut:"Meta+K",onclick:b(d),stateSelector:"a[href]"}),a.addButton("unlink",{icon:"unlink",tooltip:"Remove link",cmd:"unlink",stateSelector:"a[href]"}),a.addShortcut("Meta+K","",b(d)),a.addCommand("mceLink",b(d)),this.showDialog=d,a.addMenuItem("link",{icon:"link",text:"Insert/edit link",shortcut:"Meta+K",onclick:b(d),stateSelector:"a[href]",context:"insert",prependToContext:!0})});